<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.repository.MovieMapper">

  <select id="selectMovieList" resultType="com.project.model.MovieDto">
    SELECT
      m.MOVIE_CODE as movieCode,
      m.MOVIE_NAME as movieName,
      m.POSTER as poster,
      v.PRICE as dvdPrice,
      v.PRICE as reservePrice,
      0 as dvdDiscount,
      0 as reserveDiscount
    FROM MOVIE m
    LEFT JOIN VOD v ON m.MOVIE_CODE = v.MOVIE_CODE
    <where>
      <if test="movieName != null and movieName != ''">
        AND m.MOVIE_NAME LIKE CONCAT('%', #{movieName}, '%')
      </if>
    </where>
    ORDER BY m.MOVIE_CODE DESC
    LIMIT #{size} OFFSET #{offset}
  </select>

  <select id="countMovieList" resultType="int">
    SELECT COUNT(*)
    FROM MOVIE m
    <where>
      <if test="movieName != null and movieName != ''">
        AND m.MOVIE_NAME LIKE CONCAT('%', #{movieName}, '%')
      </if>
    </where>
  </select>

  <select id="selectMovieDetail" resultType="com.project.model.MovieDto">
    SELECT
      m.MOVIE_CODE as movieCode,
      m.MOVIE_NAME as movieName,
      m.POSTER as poster,
      m.GENRE_CODEA as genreCode,
      m.DIRECT_CODEA as directorCode,
      m.ACTOR_CODEA as actorCode,
      m.RUNTIME as runtime,
      m.RATING_TPCD as rating,
      m.MOVIE_RELEASE as releaseDate,
      v.PRICE as dvdPrice,
      v.PRICE as reservePrice
    FROM MOVIE m
    LEFT JOIN VOD v ON m.MOVIE_CODE = v.MOVIE_CODE
    WHERE m.MOVIE_CODE = #{movieCode}
  </select>


  <select id="existsByMovieName" resultType="boolean">
    SELECT EXISTS (
      SELECT 1 FROM MOVIE WHERE MOVIE_NAME = #{movieName}
    )
  </select>

  <insert id="insertMovie">
    INSERT INTO MOVIE (
      MOVIE_CODE,
      GENRE_CODEA,
      MOVIE_NAME,
      DIRECT_CODEA,
      ACTOR_CODEA,
      SYNOPSIS,
      RUNTIME,
      RATING_TPCD,
      MOVIE_RELEASE,
      POSTER,
      SALES
    )
    VALUES (
      #{id},
      'GENRE001', -- 더미 장르
      #{title},
      'DIR001', -- 더미 감독
      'ACT001', -- 더미 배우
      #{overview},
      SEC_TO_TIME(#{runtime}),
      'TP001', -- 더미 등급
      #{releaseDate},
      #{posterPath},
      0
    )
  </insert>
</mapper>